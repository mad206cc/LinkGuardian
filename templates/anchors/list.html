{% extends "_layout/base.html" %}
{% from "_layout/components.html" import content_card, status_badge, alert, note_lecture,
dropdown_single, multiselect %}
{% from "_layout/charts_simple.html" import pie_chart, bar_chart, donut_chart %}

{% block title %}Ancres - LinkGuardian{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white">Ancres de liens</h1>
            <p class="text-gray-400 mt-1">Analysez la diversité et l'optimisation de vos textes d'ancrage</p>
        </div>
    </div>
    
    <!-- Statistiques -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
        <div class="bg-gray-900 rounded-2xl p-6">
            <div class="text-2xl font-bold text-white">{{ stats.total_anchors }}</div>
            <div class="text-sm text-gray-400">Ancres uniques</div>
        </div>
        
        <div class="bg-gray-900 rounded-2xl p-6">
            <div class="text-2xl font-bold text-accent">{{ stats.branded_percentage }}%</div>
            <div class="text-sm text-gray-400">Ancres de marque</div>
        </div>
        
        <div class="bg-gray-900 rounded-2xl p-6">
            <div class="text-2xl font-bold text-primary">{{ stats.exact_match_percentage }}%</div>
            <div class="text-sm text-gray-400">Correspondance exacte</div>
        </div>
        
        <div class="bg-gray-900 rounded-2xl p-6">
            <div class="text-2xl font-bold text-warn">{{ stats.generic_percentage }}%</div>
            <div class="text-sm text-gray-400">Ancres génériques</div>
        </div>
        
    </div>
    
    <!-- Graphiques -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Distribution par type -->
        {{ donut_chart(
            chart_id="anchor-types",
            title="Répartition par type d'ancre",
            data=pie_data
        ) }}
        
        <!-- Top ancres les plus utilisées -->
        {{ bar_chart(
            chart_id="top-anchors-usage",
            title="Top 10 ancres les plus utilisées",
            orientation="h",
            data=top_data 
        ) }}
    </div>
    
    <!-- Barre de recherche -->
    <form
        hx-get="/anchors/partial/table"
        hx-target="#anchors-table"
        hx-swap="outerHTML"
        hx-trigger="change"
        class="grid grid-cols-1 md:grid-cols-6 gap-4 bg-gray-900 p-4 rounded-xl"
    >
        {# ============================
            BARRE DE RECHERCHE
        ============================ #}
        <div>
            <label class="text-gray-400 text-sm mb-1">Recherche</label>
            <input type="text"
                name="q"
                value="{{ filters.q }}"
                placeholder="URL, ancre..."
                class="w-full px-3 py-2 bg-gray-800 rounded-lg text-white">
        </div>

        {# ============================
            MULTI-USERS (Admin only)
        ============================ #}
        {% if current_user.role == 'main_admin' %}
        <div 
            class="relative min-w-[220px]"
            x-data='{
                open: false,
                selected: {{ filters.user_id|tojson if filters.user_id else "[]" }},
                allUserIds: {{ users|map(attribute="id")|list|tojson }},

                init() {

                    // Force selected à être une liste
                    if (!Array.isArray(this.selected)) {
                        this.selected = ["__all__"];
                    }
                    
                    // Si vide → Tous
                    if (this.selected.length === 0) {
                        this.selected = ["__all__"];
                    }
                },

                toggle(id) {
                    if (id === "__all__") {
                        this.selected = ["__all__"];
                        return;
                    }

                    this.selected = this.selected.filter(v => v !== "__all__");

                    if (this.selected.includes(id)) {
                        this.selected = this.selected.filter(v => v !== id);
                    } else {
                        this.selected.push(id);
                    }

                    if (this.selected.length === 0) {
                        this.selected = ["__all__"];
                    }

                    if (this.selected.length === this.allUserIds.length) {
                        this.selected = ["__all__"];
                    }
                },

                isChecked(id) {
                    return this.selected.includes(id);
                }
            }'
        >
            
            <label class="text-gray-400 text-sm mb-1">Utilisateurs</label>

            <!-- Bouton dropdown -->
            <div @click="open = !open"
                class="flex flex-wrap gap-2 px-3 py-2 bg-gray-800 border border-gray-700 rounded-xl cursor-pointer">

                <!-- 0) Si aucun utilisateur sélectionné -->
                <template x-if="selected.length === 0">
                    <span class="text-gray-400">Tous les utilisateurs</span>
                </template>

                <!-- 1) Si un seul sélectionné -->
                <template x-if="selected.length === 1">
                    <span class="text-primary"
                        x-text="selected[0] === '__all__'
                            ? 'Tous les utilisateurs'
                            : (window.userNames[selected[0]] ?? 'Utilisateur')">
                    </span>
                </template>

                <!-- 2) Si plusieurs utilisateurs sélectionnés -->
                <template x-if="selected.length > 1">
                    <span class="text-primary">Plusieurs utilisateurs</span>
                </template>

                <!-- 3) Badges individuels si plusieurs sélectionnés 
                <template x-if="selected.length > 1">
                    <template x-for="uid in selected" :key="uid">
                        <template x-if="uid !== '__all__'">
                            <span class="bg-primary/20 text-primary px-2 py-1 rounded-lg text-sm">
                                <span x-text="window.userNames[uid] ?? ('ID ' + uid)"></span>
                            </span>
                        </template>
                    </template>
                </template>
                -->

            </div>

            <!-- DROPDOWN -->
            <div x-show="open" @click.outside="open = false"
                class="absolute z-50 w-full mt-2 bg-gray-800 border border-gray-700 
                    rounded-xl shadow-xl max-h-64 overflow-y-auto p-2">

                <!-- Tous -->
                <label class="flex items-center gap-2 p-2 hover:bg-gray-700 rounded-lg cursor-pointer">
                    <input type="checkbox"
                        name="user_id"
                        value="__all__"
                        @change="toggle('__all__')"
                        :checked="isChecked('__all__')">
                    <span>Tous les utilisateurs</span>
                </label>

                <!-- Liste des utilisateurs -->
                {% for u in users %}
                    {% set full_name = (u.first_name ~ ' ' ~ u.last_name).strip() or u.email %}

                    <label class="flex items-center gap-2 p-2 hover:bg-gray-700 rounded-lg cursor-pointer">
                        <input type="checkbox"
                            name="user_id"
                            value="{{ u.id }}"
                            @change="toggle('{{ u.id }}')"
                            :checked="isChecked('{{ u.id }}')">

                        <span>
                            {% if u.id == current_user.id %}
                                {{ full_name }} (moi)
                            {% else %}
                                {{ full_name }}
                            {% endif %}
                        </span>

                        <script>
                            if (!window.userNames) window.userNames = {};
                            window.userNames["{{ u.id }}"] = "{{ full_name }}{% if u.id == current_user.id %} (moi){% endif %}";
                        </script>

                    </label>
                {% endfor %}
            </div>

            <!-- Envoi réel au backend -->
            <template x-for="uid in selected" :key="'huser-'+uid">
                <input type="hidden" name="user_id" :value="uid">
            </template>

        </div>
        {% endif %}

        {# ============================
            MULTI-TAGS
        ============================ #}
        {{ multiselect(
            "tag",
            "Tags",
            tags | map(attribute="valeur") | list,
            filters["tag"]
        ) }}

        {# ============================
            MULTI-SOURCES
        ============================ #}
        {{ multiselect(
            "source",
            "Sources",
            sources | map(attribute="nom") | list,
            filters["source"]
        ) }}

        {{ dropdown_single(
            "sort",
            "Trier par",
            {
                "count": "Fréquence (utilisations)",
                "length": "Longueur",
            },
            filters.sort
        ) }}

        {# ============================
            BOUTON - VALIDER
        ============================ #}
        <div class="flex items-end justify-start">
            <button type="submit"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm rounded-full flex items-center gap-2 shadow-md transition-all">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z"/>
                </svg>
                Valider
            </button>
            {{ note_lecture("Afin d'actualiser les statistiques et les liens, n'oubliez pas d'appuyer sur Valider.
                Pour rechercher par un tag, saisissez d'abord le nom du tag, puis sélectionner les labels et appuyez sur Entrée.") }}
        </div>

    </form>


    <div id="anchors-table">
        {% include "anchors/_anchors_table.html" with context %}
    </div>

</div>
{% endblock %}