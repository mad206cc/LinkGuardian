{% extends "_layout/base.html" %}
{% from "_layout/components.html" import pagination, quality_meter, note_lecture,
multiselect %}
{% from '_layout/charts_simple.html' import pie_chart, bar_chart, donut_chart %}

{% block title %}Domaines - LinkGuardian{% endblock %}

{% block content %}

<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white">Domaines Référents</h1>
            <p class="text-gray-400 mt-1">Analysez vos domaines référents par qualité</p>
        </div>
    </div>
    
    <!-- Statistiques globales -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-gray-900 rounded-2xl p-6">
            <div class="text-2xl font-bold text-white">{{ total_domains }}</div>
            <div class="text-sm text-gray-400">Domaines totaux</div>
            <div class="text-xs text-accent mt-1"> +{{ domains_this_month }} domaines en plus</div>
        </div>
        
        <div class="bg-gray-900 rounded-2xl p-6">
            <div class="text-2xl font-bold text-accent">{{ avg_quality_current }}/100</div>
            <div class="text-sm text-gray-400">Qualité moyenne</div>
            <div class="text-xs text-accent mt-1">+{{ quality_increase }} de qualité moyenne</div>
        </div>
        
        <div class="bg-gray-900 rounded-2xl p-6">
            <div class="text-2xl font-bold text-primary">{{ avg_backlinks_per_domain }}</div>
            <div class="text-sm text-gray-400">Backlinks moyen par domaine</div>
        </div>
        
        <div class="bg-gray-900 rounded-2xl p-6">
            <div class="text-2xl font-bold text-warn">{{ premium_domains }}</div>
            <div class="text-sm text-gray-400">Domaines premium</div>
            <div class="text-xs text-gray-400 mt-1">Score > 40</div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Répartition par qualité -->
        {{ donut_chart(
            chart_id='qualityChart',
            data=quality_distribution,
            title='Répartition par qualité'
        ) }}
        
        <!-- Top 10 domaines -->
        {{ bar_chart(
            chart_id='topDomainsChart',
            data=top_domains_chart,
            title='Top 10 des domaines (choisis en fonction de leur qualité moyenne) ',
            orientation='h'
        ) }}
    </div>

    <form 
        hx-get="/domains"
        hx-boost = "true"
        hx-target="#domains-content"
        hx-swap="outerHTML"
        hx-trigger="change"
        class="grid [grid-template-columns:repeat(auto-fit,minmax(14rem,1fr))] gap-4 bg-gray-900 p-4 rounded-xl"
    >

        {# ============================
            BARRE DE RECHERCHE
        ============================ #}
        <div>
            <label class="text-gray-400 text-sm mb-1">Recherche</label>
            <input type="text"
                name="q"
                value="{{ filters.q }}"
                placeholder="URL, ancre..."
                class="w-full px-3 py-2 bg-gray-800 rounded-lg text-white">
        </div>

        {# ============================
            MULTI-USERS (Admin only)
        ============================ #}
        {% if current_user.role == 'main_admin' %}
        <div 
            class="relative min-w-[220px]"
            x-data='{
                open: false,
                selected: {{ filters.user_id|tojson if filters.user_id else "[]" }},
                allUserIds: {{ users|map(attribute="id")|list|tojson }},

                init() {

                    // Force selected à être une liste
                    if (!Array.isArray(this.selected)) {
                        this.selected = ["__all__"];
                    }
                    
                    // Si vide → Tous
                    if (this.selected.length === 0) {
                        this.selected = ["__all__"];
                    }
                },

                toggle(id) {
                    if (id === "__all__") {
                        this.selected = ["__all__"];
                        return;
                    }

                    this.selected = this.selected.filter(v => v !== "__all__");

                    if (this.selected.includes(id)) {
                        this.selected = this.selected.filter(v => v !== id);
                    } else {
                        this.selected.push(id);
                    }

                    if (this.selected.length === 0) {
                        this.selected = ["__all__"];
                    }

                    if (this.selected.length === this.allUserIds.length) {
                        this.selected = ["__all__"];
                    }
                },

                isChecked(id) {
                    return this.selected.includes(id);
                }
            }'
        >

            <label class="text-gray-400 text-sm mb-1">Utilisateurs</label>

            <!-- Bouton dropdown -->
            <div @click="open = !open"
                class="flex flex-wrap gap-2 px-3 py-2 bg-gray-800 border border-gray-700 rounded-xl cursor-pointer">

                <!-- 0) Si aucun utilisateur sélectionné -->
                <template x-if="selected.length === 0">
                    <span class="text-gray-400">Tous les utilisateurs</span>
                </template>

                <!-- 1) Si un seul sélectionné -->
                <template x-if="selected.length === 1">
                    <span class="text-primary"
                        x-text="selected[0] === '__all__'
                            ? 'Tous les utilisateurs'
                            : (window.userNames[selected[0]] ?? 'Utilisateur')">
                    </span>
                </template>

                <!-- 2) Si plusieurs utilisateurs sélectionnés -->
                <template x-if="selected.length > 1">
                    <span class="text-primary">Plusieurs utilisateurs</span>
                </template>

                <!-- 3) Badges individuels si plusieurs sélectionnés 
                <template x-if="selected.length > 1">
                    <template x-for="uid in selected" :key="uid">
                        <template x-if="uid !== '__all__'">
                            <span class="bg-primary/20 text-primary px-2 py-1 rounded-lg text-sm">
                                <span x-text="window.userNames[uid] ?? ('ID ' + uid)"></span>
                            </span>
                        </template>
                    </template>
                </template>
                -->

            </div>

            <!-- DROPDOWN -->
            <div x-show="open" @click.outside="open = false"
                class="absolute z-50 w-full mt-2 bg-gray-800 border border-gray-700 
                    rounded-xl shadow-xl max-h-64 overflow-y-auto p-2">

                <!-- Tous -->
                <label class="flex items-center gap-2 p-2 hover:bg-gray-700 rounded-lg cursor-pointer">
                    <input type="checkbox"
                        name="user_id"
                        value="__all__"
                        @change="toggle('__all__')"
                        :checked="isChecked('__all__')">
                    <span>Tous les utilisateurs</span>
                </label>

                <!-- Liste des utilisateurs -->
                {% for u in users %}
                    {% set full_name = (u.first_name ~ ' ' ~ u.last_name).strip() or u.email %}

                    <label class="flex items-center gap-2 p-2 hover:bg-gray-700 rounded-lg cursor-pointer">
                        <input type="checkbox"
                            name="user_id"
                            value="{{ u.id }}"
                            @change="toggle('{{ u.id }}')"
                            :checked="isChecked('{{ u.id }}')">

                        <span>
                            {% if u.id == current_user.id %}
                                {{ full_name }} (moi)
                            {% else %}
                                {{ full_name }}
                            {% endif %}
                        </span>

                        <script>
                            if (!window.userNames) window.userNames = {};
                            window.userNames["{{ u.id }}"] = "{{ full_name }}{% if u.id == current_user.id %} (moi){% endif %}";
                        </script>

                    </label>
                {% endfor %}
            </div>

            <!-- Envoi réel au backend -->
            <template x-for="uid in selected" :key="'huser-'+uid">
                <input type="hidden" name="user_id" :value="uid">
            </template>

        </div>
        {% endif %}

        {# ============================
            MULTI-TAGS
        ============================ #}
        {{ multiselect(
            "tag",
            "Tags",
            tags | map(attribute="valeur") | list,
            filters["tag"]
        ) }}

        {# ============================
            MULTI-SOURCES
        ============================ #}
        {{ multiselect(
            "source",
            "Sources",
            sources | map(attribute="nom") | list,
            filters["source"]
        ) }}


        {# ============================
            BOUTON - VALIDER
        ============================ #}
        <div class="flex items-end justify-start">
            <button type="submit"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm rounded-full flex items-center gap-2 shadow-md transition-all">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-4.35-4.35M10 18a8 8 0 100-16 8 8 0 000 16z"/>
                </svg>
                Valider
            </button>
            {{ note_lecture("Afin d'actualiser les statistiques et les liens, n'oubliez pas d'appuyer sur Valider.
                Pour rechercher par un tag, saisissez d'abord le nom du tag, puis sélectionner les labels et appuyez sur Entrée.") }}
        </div>

    </form>

    <!-- Table des domaines -->
    <div id="domains-table">
        {% include "domains/_domains_table.html" with context %}
    </div>

</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>
// Graphique de répartition par qualité
const qualityCtx = document.getElementById('qualityChart').getContext('2d');
const qualityData = {{ quality_distribution_json|safe }};

new Chart(qualityCtx, {
    type: 'doughnut',
    data: {
        labels: qualityData.labels,
        datasets: [{
            data: qualityData.values,
            backgroundColor: qualityData.colors,
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: '#9ca3af',
                    padding: 15,
                    font: {
                        size: 12
                    }
                }
            }
        }
    }
});

// Graphique Top 10 domaines
const topDomainsCtx = document.getElementById('topDomainsChart').getContext('2d');
const topDomainsData = {{ top_domains_chart_json|safe }};

new Chart(topDomainsCtx, {
    type: 'bar',
    data: {
        labels: topDomainsData.labels,
        datasets: [{
            label: 'Nombre de backlinks',
            data: topDomainsData.values,
            backgroundColor: topDomainsData.colors,
            borderWidth: 0,
            borderRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        indexAxis: 'y',
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                grid: {
                    color: '#374151'
                },
                ticks: {
                    color: '#9ca3af'
                }
            },
            y: {
                grid: {
                    display: false
                },
                ticks: {
                    color: '#9ca3af',
                    font: {
                        size: 11
                    }
                }
            }
        }
    }
});
</script>

<!-- CSS pour l'indicateur de chargement -->
<style>
.htmx-indicator {
    display: none;
}
.htmx-request .htmx-indicator,
.htmx-request.htmx-indicator {
    display: inline-block;
}
</style>

{% endblock %}